<!DOCTYPE html>
<html>
<head>
    <title>Audio Transcribe</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
        }
        .end-call-button {
            width: 30px;
            height: 30px;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            border: 1px solid white;
            border-radius: 50%;;
        }
        .end-call-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .call-ended-text {
            display: none;
            color: black;
            font-weight: bold;
            margin: 10px 0;
        }
        #recordButton {
            width: 30px;
            height: 30px;
            cursor: pointer;
            border: none;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
        }
        #recordButton img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .call-controls {
            display: none;
            position: absolute;
            top: 80px;
            width: 200px;
            height: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
        }
        
        /* New styles for in-call UI */
        .profile-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 20px auto;
            margin-top: -130px;
            display: none;
        }
        
        .profile-icon {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
            z-index: 2;
        }
        
        .wave-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border: 2px solid #ffffff;
            border-radius: 50%;
            opacity: 0;
        }
        
        .wave-circle.animate {
            animation: wave 2s infinite;
        }
        
        @keyframes wave {
            0% {
                width: 100%;
                height: 100%;
                opacity: 0.8;
            }
            100% {
                width: 200%;
                height: 200%;
                opacity: 0;
            }
        }
        
        .wave-circle:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .wave-circle:nth-child(3) {
            animation-delay: 1s;
        }
        
        .in-call-text {
            display: none;
            color: #ffffff;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .call-error-text {
            display: none;
            color: #f44336;
            font-weight: bold;
            margin: 10px 0;
        }
        .contact-widget
        {
            display: flex;
            justify-content: space-between;
            background-color: rgb(238, 238, 238);
            border-radius: 10px;
            padding: 5px;
        }
        .contact-widget-left
        {
            display: flex;
            align-items: center;
        }
        .contact-widget-left img {
            width: 35px;
            height: 35px;
            object-fit: contain;
            margin-right: 15px;
        }
        .back-home
        {
            border: 1px solid;
            margin-top: 200px;
            background-color: none;
            outline: none;
            border: none;
        }
        .back-home img 
        {
            height: 30px;
            width: 30px;
            object-fit: contain;
        }
        .calling-widget
        {
            display: none;;
        }
        .cancel-call
        {
            border: none;
            outline: none;
            background-color: transparent;
        }
        .cancel-call:hover 
        {
            transform: scale(1.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .start-call {
            border: none;
            outline: none;
            background-color: transparent;
        }
        .start-call:hover 
        {
            transform: scale(1.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .start-call img {
            width: 20px;
            height: 20px;
        }
        .close-button {
            margin-top: 10px;
            padding: 8px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }

        /* Timer style */
        .call-timer {
            display: none;
            font-size: 16px;
            font-weight: bold;
            color: black;
            margin-top: -60px;
        }
        
        #responseContainer {
            width: 80%;
            max-width: 600px;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .response-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .call-ended-container {
            display: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <button id="recordButton">
        <img src="https://cdn-icons-png.flaticon.com/512/597/597177.png" alt="Phone">
    </button>
    <div class="call-controls">
        <div class="call-ended-container">
            <div class="call-ended-text">Call Ended</div>
            <button class="close-button" onClick="closeEndCallUI()">Close</button>
        </div>
        <div
            class="contact-widget"
        >
            <div class="contact-widget-left">
                 <img src="./iconCall.png" alt="Profile" class="profile-icon">
                <p>Tobi</p>
            </div>
             <button class="start-call">
                    <img src="https://cdn-icons-png.flaticon.com/512/16076/16076069.png" alt="Start Call">
                </button>
        </div>
        <div class="calling-widget">
            <p>Calling...</p>
        </div>
          <div class="back-home">
            <button class="cancel-call">
                <img src="https://cdn-icons-png.flaticon.com/512/20/20176.png" alt="Cancel Call">
            </button>   
        </div>
        
        <div class="call-timer">00:00</div>
        <div class="profile-container">
            <img src="./iconCall.png" alt="Profile" class="profile-icon">
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
        </div>
        <div class="in-call-text">In Call</div>
        <div class="call-error-text">Call Error</div>
        <button class="end-call-button" onclick="endCall()">
            <img src="https://cdn-icons-png.flaticon.com/512/14025/14025253.png" alt="End Call">
        </button>
    </div>
    <div id="responseContainer">
        <h3>Server Responses</h3>
    </div>

    <script>
        // Previous variable declarations
        let isRecording = false;
        let mediaRecorder;
        let socket;
        let timerInterval;
        let startTime;
        const recordButton = document.getElementById('recordButton');
        const callControls = document.querySelector('.call-controls');
        const startCallButton = document.querySelector('.start-call');
        const contactWidget = document.querySelector('.contact-widget');
        const callingWidget = document.querySelector('.calling-widget');
        const cancelCallButton = document.querySelector('.cancel-call');
        const inCallText = document.querySelector('.in-call-text');
        const callErrorText = document.querySelector('.call-error-text');
        const profileContainer = document.querySelector('.profile-container');
        const responseContainer = document.getElementById('responseContainer');
        const waveCircles = document.querySelectorAll('.wave-circle');
        const endCallButton = document.querySelector('.end-call-button');
        const callEndedContainer = document.querySelector('.call-ended-container');
        const callEndedText = document.querySelector('.call-ended-text');
        const closeButton = document.querySelector('.close-button');
        const callTimer = document.querySelector('.call-timer');

        function updateTimer() {
            const now = Date.now();
            const diff = Math.floor((now - startTime) / 1000); // Convert to seconds
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            callTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            startTime = Date.now();
            callTimer.style.display = 'block';
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            callTimer.style.display = 'none';
            callTimer.textContent = '00:00';
        }

        // Previous functions remain the same
        function startWaveAnimation() {
            waveCircles.forEach(wave => {
                wave.classList.add('animate');
            });
        }

        function stopWaveAnimation() {
            waveCircles.forEach(wave => {
                wave.classList.remove('animate');
            });
        }

        function playAudio(audioData) {
            const audio = new Audio('data:audio/mp3;base64,' + audioData);
            
            audio.onplay = () => {
                startWaveAnimation();
            };
            
            audio.onended = () => {
                stopWaveAnimation();
            };

            audio.onerror = () => {
                stopWaveAnimation();
                console.error('Error playing audio');
            };

            audio.play().catch(e => {
                console.error('Error playing audio:', e);
                stopWaveAnimation();
            });
        }

        function playEnterCallSound() {
            return new Promise((resolve) => {
                const enterCallAudio = new Audio('./enterCall.mp3');
                enterCallAudio.addEventListener('ended', resolve);
                enterCallAudio.play().catch(error => {
                    console.error('Error playing enter call sound:', error);
                    resolve();
                });
            });
        }

        function playEndCallSound() {
            const endCallAudio = new Audio('./endCall.mp3');
            endCallAudio.play().catch(error => {
                console.error('Error playing end call sound:', error);
            });
        }

        function showEndCallUI() {
            console.log("showEndCallUI cal")
            stopTimer();
            // Hide all other elements
            startCallButton.style.display = 'none';
            contactWidget.style.display = 'none';
            cancelCallButton.style.display = 'none';
            inCallText.style.display = 'none';
            profileContainer.style.display = 'none';
            endCallButton.style.display = 'none';
            callErrorText.style.display = 'none';

            // Show only the call ended container with text and close button
            callEndedContainer.style.display = 'flex';
            callEndedText.style.display = 'block';
            closeButton.style.display = 'block';
        }

        
        function addResponse(response, audioData) {
            const responseElement = document.createElement('div');
            responseElement.className = 'response-item';
            responseElement.textContent = response;
            responseContainer.appendChild(responseElement);
            responseContainer.scrollTop = responseContainer.scrollHeight;

            if (audioData) {
                playAudio(audioData);
            }
        }

        function showError() {
            stopTimer();
            startCallButton.style.display = 'block';
            cancelCallButton.style.display = 'block';
            inCallText.style.display = 'none';
            profileContainer.style.display = 'none';
            endCallButton.style.display = 'none';
            callErrorText.style.display = 'block';
            stopWaveAnimation();
        }

        async function startRecording() {
            try {
                callErrorText.style.display = 'none';
                callEndedContainer.style.display = 'none';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });

                const audioContext = new AudioContext({
                    sampleRate: 16000
                });
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(1024, 1, 1);

                socket = new WebSocket('ws://localhost:8765');

                socket.onopen = () => {
                    console.log('WebSocket connection established');
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'server_response') {
                            addResponse(data.message, data.audio);
                        }
                    } catch (e) {
                        console.error('Error processing server message:', e);
                        showError();
                    }
                };

                processor.onaudioprocess = (e) => {
                    if (socket.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            pcmData[i] = inputData[i] * 0x7FFF;
                        }
                        socket.send(pcmData.buffer);
                    }
                };

                socket.onclose = () => {
                    console.log('WebSocket connection closed');
                    showError();
                };

                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showError();
                };

                isRecording = true;

            } catch (err) {
                console.error('Error accessing microphone:', err);
                showError();
            }
        }

        recordButton.addEventListener('click', () => {
            callControls.style.display = callControls.style.display === 'none' ? 'block' : 'none';
        });

        startCallButton.addEventListener('click', async () => {
            startCallButton.style.display = 'none';
            contactWidget.style.display = 'none';
            cancelCallButton.style.display = 'none';

            callingWidget.style.display = 'block';
            
            await playEnterCallSound();
            
            callingWidget.style.display = 'none';

            inCallText.style.display = 'block';
            profileContainer.style.display = 'block';
            endCallButton.style.display = 'block';
            callErrorText.style.display = 'none';
            callEndedContainer.style.display = 'none';
            startTimer();
            startRecording();
        });

        cancelCallButton.addEventListener('click', () => {
            callControls.style.display = 'none';
            callErrorText.style.display = 'none';
            callEndedContainer.style.display = 'none';
        });

        closeButton.addEventListener('click', () => {
            callControls.style.display = 'none';
        });

        async function endCall() {
            showEndCallUI();

            playEndCallSound();

        }

        function closeEndCallUI(){
            window.location.reload();
        }

        // endCallButton.addEventListener('click', endCall);
    </script>
</body>
</html>